# VidGo3 项目修复文档

## 项目概述

VidGo3 是一个基于 Electron + Vue 3 + Django 的视频管理应用。本文档记录了项目启动过程中遇到的问题及其解决方案。

## 问题描述

### 1. 前端构建问题
- PostCSS 配置文件格式不正确
- Tailwind CSS 语法错误
- 缺少必要的依赖包

### 2. Electron 启动问题
- ES 模块环境下 `__dirname` 未定义
- Vite 构建时无法正确处理 Node.js 核心模块
- Electron 主进程配置不兼容

### 3. 后端服务缺失
- Python 虚拟环境未设置
- Django 数据库未初始化
- 缺少必要的 Python 依赖包

### 4. API 通信问题
- 前端无法连接后端 API
- CORS 配置不正确
- 后端服务未启动
- Django URL 路由配置错误导致 JSON 解析失败
- API 端点路径不匹配导致 404 错误

### 5. 视频播放问题
- MEDIA_ERR_SRC_NOT_SUPPORTED 错误
- Django 静态文件和媒体文件服务配置问题

### 6. CSRF 认证问题
- HTTP 403 Forbidden 错误
- getCSRFToken 未定义错误
- CSRF token 处理不正确

## 解决方案

### 前端修复

#### 1. PostCSS 配置修复
将 `postcss.config.js` 重命名为 `postcss.config.cjs`，确保 PostCSS 正确加载。

#### 2. Tailwind CSS 配置修复
修复 `tailwind.config.js` 中的语法错误，确保正确配置内容路径。

#### 3. 依赖安装
安装缺失的前端依赖：
```bash
npm install @electron-toolkit/utils
npm install electron
```

### Electron 配置修复

#### 1. ES 模块兼容性修复
在 `electron/main.ts` 中添加 ES 模块兼容代码：

```typescript
import { fileURLToPath } from 'url'
import path from 'path'

const __filename = fileURLToPath(import.meta.url)
const __dirname = path.dirname(__filename)
```

#### 2. 简化窗口加载逻辑
直接加载开发服务器 URL，避免复杂的路径处理：

```typescript
const url = 'http://127.0.0.1:8080/'
win.loadURL(url)
```

#### 3. Vite 配置优化
修改 `vite.config.electron.ts`，添加 Node.js 环境支持：

```typescript
export default defineConfig({
  build: {
    target: 'node18',
    ssr: true,
  },
  resolve: {
    alias: {
      'url': 'node:url',
      'path': 'node:path',
    },
  },
})
```

### 后端服务设置

#### 1. Python 虚拟环境创建
```bash
python -m venv venv
.\venv\Scripts\activate
```

#### 2. 依赖安装
```bash
pip install -r requirements.txt
```

#### 3. 数据库初始化
```bash
mkdir database
python manage.py migrate
```

#### 4. 启动后端服务
```bash
python manage.py runserver 9000
```

### API 通信配置

#### 1. 前端环境变量
在 `.env` 文件中配置后端地址：
```
VITE_BACKEND_ORIGIN=9000
```

#### 2. Django CORS 配置
在 `settings.py` 中添加允许的源：

```python
CORS_ALLOWED_ORIGINS = [
    "http://localhost:4173",
    "http://localhost:9000", 
    "http://127.0.0.1:4173",
    "http://localhost:8080",
    "http://127.0.0.1:8080",
    "http://localhost:9000",
    "http://127.0.0.1:9000"
]

CSRF_TRUSTED_ORIGINS = [
    "http://localhost:4173", 
    "http://localhost:9000", 
    "http://127.0.0.1:4173",
    "http://localhost:8080",
    "http://127.0.0.1:8080",
    "http://localhost:9000",
    "http://127.0.0.1:9000"
]
```

#### 3. Django URL 路由修复
修复 `backend/vid_go/urls.py` 中的 API 前缀配置：

```python
urlpatterns = [
    # 正确的 API 路由配置
    path('api/', include('video.urls')),
    # ... 其他路由
]
```

### 视频播放配置

#### 1. Django 静态文件和媒体文件配置
在 `settings.py` 中配置静态文件和媒体文件服务：

```python
STATIC_URL = '/static/'
STATICFILES_DIRS = [BASE_DIR / 'static']

MEDIA_URL = '/media/'
MEDIA_ROOT = BASE_DIR / 'media'
```

#### 2. 开发服务器媒体文件服务
在 `backend/vid_go/urls.py` 中添加媒体文件服务：

```python
from django.conf import settings
from django.conf.urls.static import static

if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
    urlpatterns += static(settings.STATIC_URL, document_root=settings.STATICFILES_DIRS[0])
```

### CSRF 认证配置

#### 1. 前端 CSRF Token 处理
在 `frontend/src/composables/GetCSRFToken.ts` 中提供 CSRF token 获取函数：

```typescript
export async function getCSRFToken(): Promise<string> {
  try {
    const response = await fetch(`${BACKEND}/api/csrf/`, {
      credentials: 'include',
    })
    const data = await response.json()
    return data.csrfToken
  } catch (error) {
    console.error('获取 CSRF token 失败:', error)
    return ''
  }
}

export function getCookie(name: string): string {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) return parts.pop()?.split(';').shift() || ''
  return ''
}
```

#### 2. 组件中正确导入和使用 CSRF Token
在 `frontend/src/components/dialogs/EnhancedSubtitleDialog.vue` 中：

```typescript
import { getCSRFToken } from '@/composables/GetCSRFToken'

async function generateBilingualSubtitles() {
  const csrfToken = await getCSRFToken()
  const res = await fetch(`${BACKEND}/api/tasks/subtitle_generate/add`, {
    method: 'POST',
    credentials: 'include',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': csrfToken,
    },
    body: JSON.stringify({
      // ... 请求数据
    }),
  })
}
```

#### 3. 后端 CSRF 豁免配置
对于需要豁免 CSRF 的视图，添加装饰器：

```python
from django.views.decorators.csrf import csrf_exempt
from django.utils.decorators import method_decorator

@method_decorator(csrf_exempt, name="dispatch")
class SubtitleGenerationAddView(View):
    def post(self, request):
        # ... 视图逻辑
```

#### 4. 后端 CSRF Token 端点
在 `backend/video/urls.py` 中添加 CSRF token 获取端点：

```python
from django.views.decorators.csrf import ensure_csrf_cookie

@ensure_csrf_cookie
def csrf_token_view(request):
    return JsonResponse({'csrfToken': get_token(request)})

urlpatterns = [
    # ... 其他路由
    path('csrf/', csrf_token_view),
]
```

## 实施步骤

### 步骤 1: 修复前端配置
1. 重命名 PostCSS 配置文件
2. 修复 Tailwind CSS 配置
3. 安装缺失的依赖包
4. 验证前端构建

### 步骤 2: 修复 Electron 配置
1. 添加 ES 模块兼容代码
2. 优化窗口加载逻辑
3. 更新 Vite 配置
4. 测试 Electron 启动

### 步骤 3: 设置后端服务
1. 创建 Python 虚拟环境
2. 安装 Python 依赖
3. 初始化数据库
4. 启动 Django 开发服务器

### 步骤 4: 配置 API 通信
1. 设置前端环境变量
2. 配置 Django CORS
3. 修复 Django URL 路由
4. 测试前后端通信
5. 验证 API 功能

### 步骤 5: 配置视频播放
1. 配置 Django 静态文件和媒体文件服务
2. 在开发服务器中启用媒体文件服务
3. 测试视频播放功能

### 步骤 6: 配置 CSRF 认证
1. 创建前端 CSRF token 获取函数
2. 在组件中正确导入和使用 CSRF token
3. 为需要的视图添加 CSRF 豁免装饰器
4. 添加后端 CSRF token 端点
5. 测试 CSRF 认证流程

## 验证结果

### 前端验证
- ✅ Vite 开发服务器成功启动在 http://127.0.0.1:8080/
- ✅ 前端页面正常加载
- ✅ API 请求成功发送到后端

### 后端验证
- ✅ Django 开发服务器成功启动在 http://127.0.0.1:9000/
- ✅ 数据库迁移成功完成
- ✅ API 端点正常响应

### 集成验证
- ✅ 前端成功获取任务列表
- ✅ API 通信正常
- ✅ Electron 应用可以正常启动和运行
- ✅ JSON 解析错误已修复
- ✅ API 端点 404 错误已修复
- ✅ 视频播放功能正常
- ✅ CSRF token 获取和使用正常
- ✅ HTTP 403 Forbidden 错误已修复
- ✅ 字幕生成任务提交成功

## 未来建议

### 1. 开发环境优化
- 使用统一的环境变量管理工具（如 dotenv）
- 配置热重载功能
- 添加开发日志记录

### 2. 构建流程优化
- 创建统一的启动脚本
- 配置生产环境构建
- 添加自动化测试

### 3. 部署准备
- 配置生产环境数据库
- 优化 Electron 打包配置
- 添加应用签名和更新机制

### 4. 文档完善
- 添加详细的 API 文档
- 编写开发者指南
- 创建故障排除指南

## 附录

### 修改的文件列表
1. `frontend/electron/main.ts` - Electron 主进程配置
2. `frontend/vite.config.electron.ts` - Vite Electron 构建配置
3. `frontend/.env` - 前端环境变量
4. `backend/vid_go/settings.py` - Django 配置
5. `frontend/postcss.config.cjs` - PostCSS 配置（重命名）
6. `frontend/tailwind.config.js` - Tailwind CSS 配置
7. `backend/vid_go/urls.py` - Django 主 URL 路由配置
8. `backend/video/urls.py` - 视频 API URL 路由配置
9. `frontend/src/composables/GetCSRFToken.ts` - CSRF token 获取函数
10. `frontend/src/composables/ConfigAPI.ts` - 后端 API 配置
11. `frontend/src/components/dialogs/EnhancedSubtitleDialog.vue` - 字幕生成对话框组件
12. `backend/video/views/subtitles.py` - 字幕生成视图

### 依赖包列表
- 前端: @electron-toolkit/utils, electron, axios, element-plus, video.js, vue, vue-router, vue3-video-play, wavesurfer.js, highlight.js, lucide-vue-next, markmap-lib, markmap-view, mermaid, waveform-data
- 后端: django, django-cors-headers, ffmpeg-python, opencv-python-headless, Pillow, openai, gunicorn, yt-dlp, pyspellchecker, librosa, soundfile

### 完整开发启动流程

#### 1. 环境准备

##### 前端环境准备
```bash
# 进入前端目录
cd frontend

# 安装前端依赖
npm install
```

##### 后端环境准备
```bash
# 进入后端目录
cd backend

# 创建 Python 虚拟环境
python -m venv venv

# 激活虚拟环境
.\venv\Scripts\activate

# 安装后端依赖
pip install -r requirements.txt
```

#### 2. 数据库初始化

```bash
# 确保已激活后端虚拟环境
.\venv\Scripts\activate

# 创建数据库目录
mkdir database

# 执行数据库迁移
python manage.py migrate
```

#### 3. 启动服务

##### 启动前端开发服务器
```bash
# 在 frontend 目录下执行
npm run dev
# 前端服务将运行在 http://127.0.0.1:8080/
```

##### 启动后端开发服务器
```bash
# 在 backend 目录下执行
.\venv\Scripts\activate
python manage.py runserver 9000
# 后端服务将运行在 http://127.0.0.1:9000/
```

##### 启动 Electron 应用（开发模式）
```bash
# 在 frontend 目录下执行
npm run electron:dev
```

#### 4. 验证服务

1. 访问前端页面：http://127.0.0.1:8080/
2. 检查后端 API：http://127.0.0.1:9000/api/
3. 验证 Electron 应用是否正常启动
4. 测试视频播放和字幕生成功能

#### 5. 关闭服务

1. 按 `Ctrl+C` 关闭前端开发服务器
2. 按 `Ctrl+C` 关闭后端开发服务器
3. 关闭 Electron 应用窗口
4. 在后端目录执行 `deactivate` 关闭虚拟环境

### 简化启动命令

如果已经完成环境准备和数据库初始化，可以使用以下命令快速启动服务：

```bash
# 前端
cd frontend && npm run dev

# 后端
cd backend && .\venv\Scripts\activate && python manage.py runserver 9000

# Electron（开发模式）
cd frontend && npm run electron:dev
```

## 最新修复记录

### 修复日期：2026-01-02

#### 问题 1：JSON 解析错误
**错误信息：**
```
请求失败： SyntaxError: Unexpected token '<', "<!DOCTYPE "... is not valid JSON
```

**原因分析：**
Django URL 路由配置错误，前端请求的 API 端点返回了 HTML 页面而不是 JSON 数据。

**解决方案：**
1. 检查并修复 `backend/vid_go/urls.py` 中的 API 路由配置
2. 确保 API 端点使用正确的 URL 模式
3. 验证所有 API 请求都指向正确的端点

#### 问题 2：API 端点 404 错误
**错误信息：**
```
404 Not Found for /api/stream_media/download_status
```

**原因分析：**
API 前缀配置不匹配，前端请求的路径与后端路由不一致。

**解决方案：**
1. 统一 API 前缀配置
2. 在 `backend/video/urls.py` 中正确配置所有 API 端点
3. 确保前端 API 请求路径与后端路由一致

#### 问题 3：视频播放错误
**错误信息：**
```
VIDEOJS: ERROR: (CODE:4 MEDIA_ERR_SRC_NOT_SUPPORTED)
```

**原因分析：**
Django 开发服务器未配置媒体文件服务，导致视频文件无法访问。

**解决方案：**
1. 在 `settings.py` 中配置 `MEDIA_URL` 和 `MEDIA_ROOT`
2. 在 `backend/vid_go/urls.py` 中添加媒体文件服务配置
3. 确保视频文件存储在正确的媒体目录中

#### 问题 4：CSRF Token 未定义错误
**错误信息：**
```
提交失败：getCSRFToken is not defined
```

**原因分析：**
在 `EnhancedSubtitleDialog.vue` 组件中使用了 `getCSRFToken` 函数，但未正确导入。

**解决方案：**
1. 在组件顶部添加正确的导入语句：
   ```typescript
   import { getCSRFToken, getCookie } from '@/composables/GetCSRFToken'
   ```
2. 确保在调用 `getCSRFToken()` 之前已经导入该函数
3. 验证 `GetCSRFToken.ts` 文件存在并导出了正确的函数

#### 问题 5：HTTP 403 Forbidden 错误
**错误信息：**
```
Error: HTTP 403
```

**原因分析：**
Django CSRF 保护机制阻止了 POST 请求，因为请求中缺少有效的 CSRF token 或后端视图未正确配置 CSRF 豁免。

**解决方案：**
1. **前端修复：**
   - 在 `EnhancedSubtitleDialog.vue` 中正确使用 `getCSRFToken()` 函数
   - 在请求头中添加 `X-CSRFToken` 字段
   - 确保请求包含 `credentials: 'include'`

2. **后端修复：**
   - 在 `backend/video/views/subtitles.py` 中为需要的视图添加 CSRF 豁免装饰器：
     ```python
     @method_decorator(csrf_exempt, name="dispatch")
     class SubtitleGenerationAddView(View):
         # ... 视图逻辑
     
     @method_decorator(csrf_exempt, name="dispatch")
     class SubtitleGenerationTaskView(View):
         # ... 视图逻辑
     ```
   - 在 `settings.py` 中添加端口 9000 到 CSRF_TRUSTED_ORIGINS

3. **验证修复：**
   - 测试字幕生成任务提交功能
   - 确认不再出现 HTTP 403 错误
   - 验证任务成功提交到后端

#### 问题 6：端口配置更新
**修改内容：**
- 将后端服务端口从 8000 更改为 9000
- 更新所有相关的 CORS 和 CSRF 配置
- 更新前端环境变量 `VITE_BACKEND_ORIGIN=9000`

**原因：**
为了避免与其他服务端口冲突，统一使用端口 9000 作为后端服务端口。

**影响范围：**
- `backend/vid_go/settings.py` - 更新 CORS_ALLOWED_ORIGINS 和 CSRF_TRUSTED_ORIGINS
- `frontend/.env` - 更新 VITE_BACKEND_ORIGIN
- 所有 API 请求的基础 URL

### 修复总结

本次修复主要解决了以下核心问题：

1. **API 通信问题：** 修复了 URL 路由配置和端点路径不匹配的问题
2. **媒体文件服务：** 配置了 Django 开发服务器的媒体文件服务，解决了视频播放问题
3. **CSRF 认证：** 完善了 CSRF token 的获取和使用机制，解决了 HTTP 403 错误
4. **端口配置：** 统一使用端口 9000，更新了所有相关配置
5. **数据库配置：** 确保 SQLite 数据库正确配置和初始化

所有修复都经过验证，确保了前后端通信、视频播放和字幕生成功能的正常运行。

### 项目当前状态

- **前端**：
  - 使用 Vue 3 + Vite 构建
  - 集成 Electron 用于桌面应用
  - 视频播放使用 video.js 和 wavesurfer.js
  - 状态管理：组件内状态管理
  - 样式：Tailwind CSS + Element Plus

- **后端**：
  - Django 框架
  - SQLite 数据库
  - RESTful API 设计
  - 媒体文件服务配置完成
  - CORS 和 CSRF 配置正确

- **数据库**：
  - SQLite 数据库文件位于 `backend/database/videos.db`
  - 数据库迁移已配置
  - 支持视频元数据、字幕、用户配置等数据存储

### 技术栈总结

| 类别 | 技术/框架 | 版本 |
|------|-----------|------|
| 前端框架 | Vue | 3.4.0 |
| 构建工具 | Vite | 5.0.0 |
| 桌面框架 | Electron | 28.0.0 |
| UI 组件库 | Element Plus | 2.4.0 |
| 视频播放 | Video.js | 8.23.4 |
| 音频可视化 | WaveSurfer.js | 7.12.1 |
| API 通信 | Axios | 1.6.0 |
| 代码高亮 | Highlight.js | 11.11.1 |
| 图标库 | Lucide Vue Next | 0.562.0 |
| 思维导图 | Markmap | 0.18.12 |
| 图表库 | Mermaid | 11.12.2 |
| 后端框架 | Django | 6.0 |
| 数据库 | SQLite | 最新 |
| 样式框架 | Tailwind CSS | 3.3.6 |
| 跨域支持 | django-cors-headers | 最新 |
| 音视频处理 | FFmpeg-Python | 最新 |
| 图像处理 | OpenCV | 最新 |
| 图像处理 | Pillow | 最新 |
| AI 服务 | OpenAI | 最新 |
| 视频下载 | yt-dlp | 最新 |
| 音频处理 | Librosa | 最新 |
| 音频读写 | SoundFile | 最新 |

---

**文档创建日期**: 2026-01-01
**最后更新日期**: 2026-01-02
**项目版本**: 当前开发版本
**维护者**: VidGo3 开发团队